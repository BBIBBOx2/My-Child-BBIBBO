<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">

<head>
    <meta charset="utf-8">
    <title>BBIBBOx2_demo</title>
    <script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
    <script th:src="@{'https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId='+${@environment.getProperty('naver.id')}}"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
    <script type="text/javascript" th:src="@{../../static/assets/MarkerClustering.js}"></script>


</head>

<body onload="javascript:initMap()">

<div id="map" style="width:100%;height:800px;"></div>
<script type="text/javascript">
    var map = new naver.maps.Map("map", {
        zoom: 7,
        center: new naver.maps.LatLng(37.527467, 126.982318),
        zoomControl: true,
        zoomControlOptions: {
            position: naver.maps.Position.TOP_LEFT,
            style: naver.maps.ZoomControlStyle.SMALL
        }
    });

    //클러스터 마크 정의
    var htmlMarker1 = {
            content: '<div style="cursor:pointer;width:40px;height:40px;line-height:42px;font-size:10px;color:white;text-align:center;font-weight:bold;background:url(/static/images/cluster-marker-1.png);background-size:contain;"></div>',
            size: N.Size(40, 40),
            anchor: N.Point(20, 20)
        },
        htmlMarker2 = {
            content: '<div style="cursor:pointer;width:40px;height:40px;line-height:42px;font-size:10px;color:white;text-align:center;font-weight:bold;background:url(/static/images/cluster-marker-2.png);background-size:contain;"></div>',
            size: N.Size(40, 40),
            anchor: N.Point(20, 20)
        },
        htmlMarker3 = {
            content: '<div style="cursor:pointer;width:40px;height:40px;line-height:42px;font-size:10px;color:white;text-align:center;font-weight:bold;background:url(/static/images/cluster-marker-3.png);background-size:contain;"></div>',
            size: N.Size(40, 40),
            anchor: N.Point(20, 20)
        },
        htmlMarker4 = {
            content: '<div style="cursor:pointer;width:40px;height:40px;line-height:42px;font-size:10px;color:white;text-align:center;font-weight:bold;background:url(/static/images/cluster-marker-4.png);background-size:contain;"></div>',
            size: N.Size(40, 40),
            anchor: N.Point(20, 20)
        },
        htmlMarker5 = {
            content: '<div style="cursor:pointer;width:40px;height:40px;line-height:42px;font-size:10px;color:white;text-align:center;font-weight:bold;background:url(/static/images/cluster-marker-5.png);background-size:contain;"></div>',
            size: N.Size(40, 40),
            anchor: N.Point(20, 20)
        };


    var markers = [], infoWindows=[];

    function initMap() {

        $.ajax({
            type:"get",
            url:"data.json",
            dataType:"json",
            success: function(data){
                $.each(data , function(i){
                    var x = data[i].latitude;
                    var y = data[i].longitude;
                    var marker = new naver.maps.Marker({
                        position: new naver.maps.LatLng(x, y),
                        map: map,
                        draggable: false
                    });
                    var detailUrl = "/hospital/detail/" + data[i].hpId;
                    var infoWindow = new naver.maps.InfoWindow({
                        content:
                            '<div style="width:200px;text-align:left;padding-left:10px;padding-right: 10px; padding-bottom: 5px;"><b>병원명: '+ data[i].name +'</b></div>'+
                            '<div style="width:200px;text-align:left;padding-left:10px;padding-right: 10px; padding-bottom: 5px;"><b>주소: '+ data[i].address +'</b></div>'+
                            '<div style="width:200px;text-align:left;padding-left:10px;padding-right: 10px; padding-bottom: 10px;font-size: small;"><a href=' + detailUrl + '>상세보기</a></div>'
                    });
                    markers.push(marker);
                    infoWindows.push(infoWindow);

                });


                //클러스터링
                var markerClustering = new MarkerClustering({
                    minClusterSize: 1,
                    maxZoom: 8,
                    map: map,
                    markers: markers,
                    disableClickZoom: false,
                    gridSize: 120,
                    icons: [htmlMarker1, htmlMarker2, htmlMarker3, htmlMarker4, htmlMarker5],
                    indexGenerator: [5, 8, 10, 13, 15],
                    stylingFunction: function(clusterMarker, count) {
                        $(clusterMarker.getElement()).find('div:first-child').text(count);
                    }
                });

                function getClickHandler(seq){
                    return function(e) {
                        var marker = markers[seq],
                            infoWindow = infoWindows[seq];

                        if (infoWindow.getMap()) {
                            infoWindow.close();
                        } else {
                            infoWindow.open(map, marker);
                        }
                    }
                }

                for (var i=0, ii=markers.length; i<ii; i++) {
                    naver.maps.Event.addListener(markers[i], 'click', getClickHandler(i));
                }


            },
            error:function(){
                console.log("통신에러");
            }
        })
    }


</script>

</body>

</html>